#Donwload Azure CLI and PowerShell
#CLI Download MSI-Installation Program: https://docs.microsoft.com/de-de/cli/azure/install-azure-cli-windows?view=azure-cli-latest
#PowerShell: Install-Module -Name AzureRM


#Login
Connect-AzureRmAccount

#Set Variables
<#
$location = "westeurope"
$resourceGroup = "RG-Test1"
$iHName = "IH-Test1"
$deviceName = "MyDevice"
$saName = "msasati3007"
$storageAccountName = "msaskti3007"
$containerName = "msascti3007"
$jobInputName = "IHInput"
$jobInputDefinitionFile = "C:\Users\tom-marvin.ihme\Desktop\EdgeSchulung\Automatisierung\SAFiles\JobInputDefinition.json"
$jobOutputName = "MyBlobOutput"
$jobOutputDefinitionFile = "C:\Users\tom-marvin.ihme\Desktop\EdgeSchulung\Automatisierung\SAFiles\JobOutputDefinition.json"
$jobTransformationName = "MyJobTransformation"
$jobTransformationDefinitionFile = "C:\Users\tom-marvin.ihme\Desktop\EdgeSchulung\Automatisierung\SAFiles\JobTransformationDefinition.json"
#>

#Create Resource Group
New-AzureRmResourceGroup -Name "RG-Test1" -Location "Westeurope"

#Create IoT-Hub
New-AzureRmIotHub -ResourceGroupName "RG-Test1" -Name "IH-Test1" -SkuName "S1" -Units 1 -Location "Westeurope"

#Create Device (new Command)
az iot device create --hub-name "IH-Test1" --device-id "MyDevice"

#Create Storage Account
$storageAccount = New-AzureRmStorageAccount -ResourceGroupName "RG-Test1" -Name "msaskti3007" -Location "Westeurope" -SkuName "Standard_LRS" -Kind "Storage"
$ctx = $storageAccount.Context

#Create Storage Container
New-AzureStorageContainer -Name "msascti3007" -Context $ctx

#Variable Storage Account Key
$storageAccountKey = (Get-AzureRmStorageAccountKey -ResourceGroupName "RG-Test1" -Name "msaskti3007").Value[0]



#Create new SA Job
New-AzureRmStreamAnalyticsJob -ResourceGroupName "RG-Test1" -File "C:\Users\tom-marvin.ihme\Desktop\EdgeSchulung\Automatisierung\SAFiles\JobDefinition.json" -Name "msasati3007"

#Configure Input Json for SA
$a = Get-Content 'C:\Users\tom-marvin.ihme\Desktop\EdgeSchulung\Automatisierung\SAFiles\JobInputDefinition.json' -raw | ConvertFrom-Json
$a.Properties.DataSource.Properties.iotHubNamespace = "IH-Test1"
$a.Properties.DataSource.Properties.sharedAccessPolicyKey = (Get-AzureRmIotHubKey -ResourceGroupName "RG-Test1" -Name "IH-Test1" -KeyName "iothubowner").PrimaryKey
$a | ConvertTo-Json -Depth 5 | set-content 'C:\Users\tom-marvin.ihme\Desktop\EdgeSchulung\Automatisierung\SAFiles\JobInputDefinition.json'

#Create IH Input for SA
New-AzureRmStreamAnalyticsInput -ResourceGroupName "RG-Test1" -JobName "msasati3007" -File 'C:\Users\tom-marvin.ihme\Desktop\EdgeSchulung\Automatisierung\SAFiles\JobInputDefinition.json' -Name "IHInput"

#Configure Output Json for SA
$a = Get-Content 'C:\Users\tom-marvin.ihme\Desktop\EdgeSchulung\Automatisierung\SAFiles\JobOutputDefinition.json' -raw | ConvertFrom-Json
$a.Properties.DataSource.Properties.storageAccounts[0].accountName = "msaskti3007"
$a.Properties.DataSource.Properties.storageAccounts[0].accountKey = (Get-AzureRmStorageAccountKey -ResourceGroupName "RG-Test1" -AccountName "msaskti3007").Value[0]
$a.Properties.DataSource.Properties.container = "msascti3007"
$a | ConvertTo-Json -Depth 5 | set-content 'C:\Users\tom-marvin.ihme\Desktop\EdgeSchulung\Automatisierung\SAFiles\JobOutputDefinition.json'

#Create BLOB Output for SA
New-AzureRmStreamAnalyticsOutput -ResourceGroupName "RG-Test1" -JobName "msasati3007" -File 'C:\Users\tom-marvin.ihme\Desktop\EdgeSchulung\Automatisierung\SAFiles\JobOutputDefinition.json' -Name "MyBlobOutput"

#Create Query for SA Job
New-AzureRmStreamAnalyticsTransformation -ResourceGroupName "RG-Test1" -JobName "msasati3007" -File "C:\Users\tom-marvin.ihme\Desktop\EdgeSchulung\Automatisierung\SAFiles\JobTransformationDefinition.json" -Name "MyJobTransformation" -Force

#Start SA Job
Start-AzureRmStreamAnalyticsJob -ResourceGroupName $resourceGroup -Name $saName -OutputStartMode "JobStartTime"
#Print ConnectionString for Device
Write-Host "ConnectionString for Device: " -ForegroundColor Magenta `
(az iot device show-connection-string --hub-name $iHName --device-id $deviceName | ConvertFrom-Json).connectionString
#DONE













